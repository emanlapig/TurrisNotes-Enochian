var Controller=function(){var a=this;this.init=function(){a.ls.update_cache(),a.ls.update_model(),a.page.calls.init()},this.page={calls:{init:function(){view.page.calls.init(),view.page.poll.init({func:function(){$(".page.calls h3.call-title")===model.calls.length&&(view.page.poll.polling=!1)},freq:200,callback:function(){var b=$(".page.calls h3.call-title");$(".page.calls .btn.new-call").unbind().on("click touchstart",function(b){view.page.go_to({to:".page.edit-call",from:".page.calls",direction:"left"}),a.page.calls.unbind(),a.page.new_call.init()});for(var c=0;c<b.length;c++)$(b[c]).on("click touchstart",function(b){view.page.go_to({to:".page.edit-call",from:".page.calls",direction:"left"}),a.page.calls.unbind(),console.log($(b.target).attr("data-id")),a.page.edit_call.init({id:$(b.target).attr("data-id")})})}})},unbind:function(){$(".page.calls h3, .page.calls .btn").unbind()}},new_call:{init:function(){void 0===model.last_call?model.last_call=0:model.last_call+=1,a.ls.update_last_call(model.last_call);var b={id:model.last_call,title:"New Call",words:[]},c=b.id;a.ls.add_call(b),view.page.edit_call.init({action:"new call",id:c}),a.page.new_call.unbind(),$(".page.edit-call .btn.add-word").on("click touchstart",function(b){model.last_word+=1,a.ls.update_last_word(model.last_word);var d={id:model.last_word,enoA:$(".page.edit-call input#enoA").val(),enoB:$(".page.edit-call input#enoB").val(),eng:$(".page.edit-call input#eng").val()},e=view.utils.get_call(c);e.title=$(".page.edit-call input#call-title").val()||"New Call",a.page.add_word({word:d,call:e}),a.page.render_word_list()})},unbind:function(){$(".page.edit-call .btn.add-word").unbind()}},edit_call:{init:function(b){var c=b.id;view.page.edit_call.init({action:"edit call",id:c}),a.page.render_word_list()}},render_word_list:function(){view.page.render_word_list(),view.page.poll.init({func:function(){console.log("poll");var a=$(".page.edit-call .words-list .word"),b=view.utils.get_call(view.page.edit_call.call_id);a.length===b.words.length&&(view.page.poll.polling=!1)},freq:200,callback:function(){console.log("word list done")}})},add_word:function(b){for(var c=b.word,d=b.call,e=!1,f=0;f<model.words.length;f++)if(model.words[f].enoA==c.enoA&&model.words[f].enoB==c.enoB&&model.words[f].eng==c.eng){e=model.words[f];break}for(var f=0;f<a.ls.cache.length;f++)if(a.ls.cache[f].enoA==c.enoA&&a.ls.cache[f].enoB==c.enoB&&a.ls.cache[f].eng==c.eng){e=a.ls.cache[f];break}e?d.words.push(e.id):(a.ls.add_word(c),d.words.push(c.id)),a.ls.edit_call(d)}},this.ls={cache:[],update_cache:function(){a.ls.cache=JSON.parse(window.localStorage.getItem("turrisModel"))||[],console.log("update_cache",a.ls.cache)},update_ls:function(){window.localStorage.setItem("turrisModel",JSON.stringify(a.ls.cache)),console.log("update_ls",window.localStorage.getItem("turrisModel"))},update_model:function(){model=new Model,a.ls.update_cache();var b=a.ls.cache;if(null!=b)for(var c=0;c<b.length;c++)switch(b[c].action){case"new word":var d={id:b[c].id,enoA:b[c].enoA,enoB:b[c].enoB,eng:b[c].eng};model.words.push(d);break;case"edit word":case"delete word":break;case"new call":var e={id:b[c].id,title:b[c].title,words:b[c].words};model.calls.push(e);break;case"edit call":for(var e={id:b[c].id,title:b[c].title,words:b[c].words},f=0;f<model.calls.length;f++)model.calls[f].id==b[c].id&&(model.calls[f]=e)}var g=window.localStorage.getItem("turrisCalls"),h=window.localStorage.getItem("turrisWords");null!==g&&(model.last_call=Number(g)),null!==h&&(model.last_word=Number(h)),console.log("update_model",model)},add_word:function(b){a.ls.update_cache();var b=b;b.action="new word",a.ls.cache.push(b),a.ls.update_ls(),a.ls.update_model()},add_call:function(b){a.ls.update_cache();var b=b;b.action="new call",a.ls.cache.push(b),a.ls.update_ls(),a.ls.update_model()},edit_call:function(b){a.ls.update_cache();var b=b;b.action="edit call",a.ls.cache.push(b),a.ls.update_ls(),a.ls.update_model()},update_last_call:function(a){window.localStorage.setItem("turrisCalls",a)},update_last_word:function(a){window.localStorage.setItem("turrisWords",a)}}};